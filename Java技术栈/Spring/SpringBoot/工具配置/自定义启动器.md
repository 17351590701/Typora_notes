# starter启动器

## springboot3环境

1.自定义启动器创建springboot3项目 如果使用了HttpServletrequest,可以使用`web`启动器

项目命名

```java
xxx-spring-boot-starter
```

可以按照情况删除其他依赖，只保留spring-boot-starter-web



2.引入依赖

```java
<dependency>
   <groupId>org.springframework.boot</groupId>
   <artifactId>spring-boot-autoconfigure</artifactId>
   <version>3.0.7</version>
 </dependency>
```

3.在resoureces/META-INF/spring文件夹

`org.springframework.boot.autoconfigure.AutoConfiguration.imports` 文件

中写入配置类的`全类名`

```java
org.example.ip_spring_boot_starter.config.IpConfiguration
org.example.ip_spring_boot_starter.config.SpringMvcConfig
```



## ip地址计数

新建项目 ip-spring-boot-starter

### 1.配置类

```java
public class IpConfiguration {
    @Bean
    public IpCountService ipCountService() {
        return new IpCountService();
    }
}
```

### 2.服务类

```java
public class IpCountService {
    private final Logger logger = Logger.getLogger("IpCountService");
    private final HashMap<String,Integer> map = new HashMap<>();
    @Resource
    private HttpServletRequest request;
    public void count(){
        String ip = request.getRemoteAddr();
        map.merge(ip, 1, Integer::sum);
        logger.info("ip:"+ip+"访问次数："+map.get(ip));
    }
}
```

### 3.自动配置文件

META-INF/spring/org.springframework.boot.autoconfigure.AutoConfiguration.imports

```java
org.example.ip_spring_boot_starter.config.IpConfiguration
```



### 4.对maven项目安装

 --clean--install 使其他项目能引入坐标



### 5.引入坐标

在需要使用starter的项目中引入坐标

```java
<dependency>
   <groupId>org.example</groupId>
   <artifactId>ip_spring_boot_starter</artifactId>
   <version>0.0.1-SNAPSHOT</version>
</dependency>
```



### 6.简单调用

```java
@RestController
@RequestMapping("/users")
public class UserController {
    @Resource
    private UserService userService;
    @Resource
    private IpCountService ipCountService;

    @GetMapping("/list")
    public List<User> getList(){
        ipCountService.count();
        return userService.list();
    }
}
```



### 7.增加拦截器

完全隔断主项目和starter启动项目

将上述的 IpCountService 和方法调用从主项目抽离到 starter启动项目中

```java
public class IpCountInterceptor implements HandlerInterceptor {
    @Resource
    private IpCountService ipCountService;
    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
        ipCountService.count();
        return true;
    }
}
```

### 8.配置拦截器

```java
@Configuration
public class SpringMvcConfig implements WebMvcConfigurer {
    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(ipCountInterceptor()).addPathPatterns("/**");
    }

    @Bean
    public IpCountInterceptor ipCountInterceptor() {
        return new IpCountInterceptor();
    }
}
```

### 9.配置自动配置SpringMvcConfig

> 注意，虽然都配置了自动配置
>
> 但IpConfiguration不需要 @Configuration注解
>
> 但SpringMvcConfig需要 @Configuration

META-INF/spring/org.springframework.boot.autoconfigure.AutoConfiguration.imports

```java
org.example.ip_spring_boot_starter.config.IpConfiguration
org.example.ip_spring_boot_starter.config.SpringMvcConfig
```



### 10.完成低耦合

再次maven --clean --install 重新安装，重新引入坐标





> SpringBoot2.7之前
>
> - resourece/META-INF/spring.factories文件里添加
> - `org.springframework.boot.autoconfigure.EnableAutoConfiguration=XXAutoConfiguration`
> - `配置类全类名`
>
> 
>
> SpringBoot2.7推出新的自动配置
>
> 在META-INF/spring/org.springframework.boot.autoconfigure.AutoConfiguration.imports
> 文件里添加配置类名称，每行包含一个配置类全限定名
> 兼容META-INF/spring.factories方式
>
> 
>
> SpringBoot3.x 
>
> 移除spring.factories
>
> 移除META-INF/spring.factories方式
> 只支持META-INF/spring/org.springframework.boot.autoconfigure.AutoConfiguration.imports 增加自动配置