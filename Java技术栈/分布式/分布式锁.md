## 问题引入

超卖问题，每个人秒杀商品时，由于延迟，都查询到库存有余额（其他人未秒杀），进行秒杀业务，导致库存为负，形成超卖。

解决：synchronized锁解决，重量级锁，造成阻塞，速度慢。

分布式情况下，多服务实例，互不认识，锁不一样，不具备互斥条件

解决：锁不互相信任


## MYSQL分布式锁

==主键==冲突或者==唯一索引==来实现

lock()就添加该主键id

unlock()就删除该行记录

## Redis分布式锁

### Redis单节点方案

==SETNX== 【SET if Not Exist】

为了避免程序挂掉导致key未删除，形成死锁，为key添加==过期时间==ttl

设置时间需要时==原子==操作 : setnx key value ttl

或者使用Lua脚本来进行操作

### 过期时间引发的问题

- 程序未执行完，锁过期
- 删除了别人加的锁

<img src="https://gitee.com/yurun-zhang/typora-tu-chuang/raw/master/202408011822792.png" alt="image-20240801182213733" style="zoom:67%;" />

#### 解决：

- 程序未执行完，锁过期时，看门狗（WatchDog）自动续期
- 锁是键值对结构，判断key的value是否是自己加的，防止释放别人的锁



### Redis锁性能如何提升

- 减小锁粒度：尽可能减小锁期间的代码执行数

- 分段锁：库存拆分，将一个分布式锁，拆分为多个
- 

### 主从集群问题

主节点生成锁lock后， 异步进行主从复制，还未同步到从节点，就挂掉了，导致新的从节点变为主节点时，没有这把锁lock，导致新的请求也setnx获得了锁，形成超卖问题



#### 红锁

- Redlock（Redis红锁），没有主从节点概念，而是给所有redis节点加锁，有半数以上成功加锁才算成功，执行逻辑

  > ==注意==：
  >
  > - Redlock保证高可用是**增加redis机器**，而不应该给每个redis节点再分配从节点，否则redis节点同步到从节点时，主挂了，导致投票失败，又会引发超卖问题
  > - 机器应该为**奇数**，即3、5、7，而不应该4或者6这样，应为以半数投票，3和4没区别，还增加了资源的浪费
  > - 由于AOF持久化，可能程序1获取了一把锁，而程序2有两把，即超过了半数，程序2依然可以执行操作

  ![image-20240801215300555](https://gitee.com/yurun-zhang/typora-tu-chuang/raw/master/202408012153624.png)

- Zookeeper更偏向CAP原则中的CP，而Redis是AP，当Zk获取锁时，会先同步给从节点，当主节点挂了，底层ZAB机制会优先选取同步成功的从节点为主节点

## Redisson

### Redisson的使用

1. 导入依赖

   ```xml
   <dependency>
   	<groupId>org.redisson</groupId>
      <artifactId>redisson</artifactId>
   </dependency>
   ```

2. 配置Bean

   ```java
   @Bean
   public Redisson redisson(){
      //此为单机模式
      Config config = new Config();
      config.useSingleServer().setAddress("redis://localhost:6379").set	Database(0);
      //config.setLockWatchdogTimeout(10000)//看门狗超时时间
      return (Redisson) Redisson.create(config);
   }
   ```

3. 使用

   ```java
   @Resource
   private Redisson redisson;
   // 获取锁对象，lockKey 分布式锁key
   RLock redissonLock = redisson.getLock(lockKey);
   redisson.lock();
   ...
   redisson.unlock();
   ```



### Redisson分布式锁原理

![image-20240801212105606](https://gitee.com/yurun-zhang/typora-tu-chuang/raw/master/202408012121703.png)

