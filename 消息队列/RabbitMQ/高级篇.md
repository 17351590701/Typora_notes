# 生产者可靠性

## 生产者重连

> 由于网络波动，可能会出现客户端MQ连接失败。通过配置开启失败重连机制：
>
> ==注意==：SpringAMQP提供的重试机制是==阻塞式==的重试，也就是说多次重试等待的过程中，当前线程是被阻塞的，会影响业务性能
>
> 对业务性能有要求，建议==禁用==重试机制，或合理配置等待时长、重试次数，或采用==异步线程==完成

`publisher`

```yml
spring:
  rabbitmq:
    host: localhost
    port: 5672
    virtual-host: /hmall
    username: hmall
    password: 123
    connection-timeout: 1s #MQ连接超时时间
    template:
      retry:
        enabled: true #开启重试 默认 false
        #以下为默认设置
        initial-interval: 1000ms #初始等待时间 默认 1000ms
        multiplier: 1 #失败后下次重试的时间倍数 默认 1
        max-attempts: 3 #最大重试次数 默认 3
```

## 生产者确认

<img src="https://gitee.com/yurun-zhang/typora-tu-chuang/raw/master/202406061737390.png" alt="image-20240602155023803" style="zoom:67%;" />

<img src="https://gitee.com/yurun-zhang/typora-tu-chuang/raw/master/202406061737391.png" alt="image-20240602161852240" style="zoom:67%;" />

# MQ的可靠性

<img src="https://gitee.com/yurun-zhang/typora-tu-chuang/raw/master/202406061737392.png" alt="image-20240602162217814" style="zoom:67%;" />

## 数据持久化

- 交换机持久化
- 队列持久化
- 消息持久化

## LazyQueue

> 从RabbitMQ 的 3.6.0版本开始，就增加了LazyQueue概念，惰性队列
>
> - 接收到消息后直接存入磁盘而非内存（内存中只保留最近的消息，默认2048条）
> - 消费者要消费消息时才会从磁盘中读取并加载到内存
> - 支持百万条的消息存储

==注意==：在RabbitMQ 3.12.0版本后，所有队列都是LazyQueue模式，无法更改

<img src="https://gitee.com/yurun-zhang/typora-tu-chuang/raw/master/202406061737393.png" alt="image-20240602163951537" style="zoom:67%;" />

# 消费者可靠性

## 消费者确认机制 

<img src="https://gitee.com/yurun-zhang/typora-tu-chuang/raw/master/202406061737394.png" alt="image-20240602165141132" style="zoom:67%;" />

## 失败重连机制

<img src="https://gitee.com/yurun-zhang/typora-tu-chuang/raw/master/202406061737395.png" alt="image-20240602165318295" style="zoom:67%;" />

<img src="https://gitee.com/yurun-zhang/typora-tu-chuang/raw/master/202406061737396.png" alt="image-20240602171836905" style="zoom:67%;" />

## 业务幂等性

### 唯一id

<img src="https://gitee.com/yurun-zhang/typora-tu-chuang/raw/master/202406061737397.png" alt="image-20240602172539674" style="zoom:67%;" />

### 业务判断

<img src="https://gitee.com/yurun-zhang/typora-tu-chuang/raw/master/202406061737398.png" alt="image-20240602172758183" style="zoom:67%;" />

```java
    public void listenOrderPay(Long orderId) {
    // //     查询订单
    //     Order order = orderService.getById(orderId);
    //     // 判断订单状态是否为未支付
    //     if(order==null||order.getStatus()!=1){
    //         return;
    //     }
    //     // 若未支付 1 ，标记订单状态为已支付 2
    //     orderService.markOrderPaySuccess(orderId);
        orderService.lambdaUpdate()
                .set(Order::getStatus,2)
                .set(Order::getPayTime,LocalDateTime.now())
                .eq(Order::getId,orderId)
                .eq(Order::getStatus,1)
                .update();
    }
```

<img src="https://gitee.com/yurun-zhang/typora-tu-chuang/raw/master/202406061737399.png" alt="image-20240602174413129" style="zoom:67%;" />

# 延迟消息

> **延迟消息**：生产者发送消息时指定一个时间，消费者不会立刻收到消息，而是在指定时间之后才收到消息
>
> **延迟任务**：设置在一定时间之后才执行的任务

<img src="https://gitee.com/yurun-zhang/typora-tu-chuang/raw/master/202406061737400.png" alt="image-20240602174848207" style="zoom:67%;" />

## 死信交换机

<img src="https://gitee.com/yurun-zhang/typora-tu-chuang/raw/master/202406061737401.png" alt="image-20240602180033972" style="zoom:67%;" />

## 延迟消息插件

插件地址：

https://github.com/rabbitmq/rabbitmq-delayed-message-exchange/releases

<img src="https://gitee.com/yurun-zhang/typora-tu-chuang/raw/master/202406061737402.png" alt="image-20240602180431372" style="zoom: 67%;" />

<img src="https://gitee.com/yurun-zhang/typora-tu-chuang/raw/master/202406061737403.png" alt="image-20240602180459858" style="zoom: 67%;" />

## 取消超时订单

<img src="https://gitee.com/yurun-zhang/typora-tu-chuang/raw/master/202406061737404.png" alt="image-20240602181429039" style="zoom:67%;" />

<img src="https://gitee.com/yurun-zhang/typora-tu-chuang/raw/master/202406061737405.png" alt="image-20240602181451527" style="zoom:67%;" />